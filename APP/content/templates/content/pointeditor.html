{% extends 'base/base.html'%}
{%load general %}
{%load static %}

{%block page_name%}
Point editor
{%endblock%}

{%block title%}
Editor
{%endblock%}


{%block content%}
{%definevar 'editorpoint' as alert_loc%}
{%include 'base/alert.html'%}
<script src="{%static 'content/js/editingcontroller.js'%}"></script>
{%include 'content/mathjax.html'%}

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="js/jquery-1.10.1.min.js"><\/script>')</script>
<script src="https://kit.fontawesome.com/7db096792c.js" crossorigin="anonymous"></script>


<script>
var object_id = "{{context.point.id}}";
var object_type = "Point";
</script>


{{ccontext.url}}
{{ccontext.point.p_content}}






{%include 'content/items/GPT_item.html'%}
{%include 'content/items/editor_items.html'%}
<div class="card-body">
	<div class="card shadow">
		<div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
			<h5 class="h4 mb-1 text-primary font-weight-bold">
				<a href='
{%if 'contribution' in context.url%}
{%url 'content:contribution_noteedit' context.task.id %}#point_{{context.point.id}}
{%else%}
{%url 'content:noteedit' context.spec.id context.point.p_moduel context.point.p_chapter%}#point_{{context.point.id}}
{%endif%}
			'>
{{context.point.p_topic|field_name_to_label}}: {{context.point.p_title|field_name_to_label}}
			</a>
			</h5>
		</div>
	</div>
</div>



<div class='spec_organiser_container_notice' id='spec_organiser_container_notice'>
	Please Use a desktop on chrome to see the editor, or zoom out.
</div>
<form id='target' target="transFrame" class="user px-3 py-3 editing_form"  action="{%url 'content:_savepointedit'%}" 
	method="POST" role="form" enctype="multipart/form-data">
    {% csrf_token %}
    <input type='hidden' value='{{context.point.id}}' name='point_id'/>
    {{ context.editormedia}}
    {{ context.editorrender}}
    <button type='submit' class='btn btn-primary' id='save_content_button'>Save</button> <span id="saving_indicator"> all saved</span>
</form>
<iframe style="" name="transFrame" id="transFrame" hidden='hidden'></iframe>


<script>
$( "#target" ).on( "submit", function( event ) {
	var s = document.getElementById('saving_indicator');
	s.innerHTML = 'saving...'
});
$('iframe#transFrame').load(function() {
	const responseValue = this.contentWindow.document.body.innerHTML;
	// Extract JSON string from the response value
	const jsonStart = responseValue.indexOf('{');
	const jsonEnd = responseValue.lastIndexOf('}');
	const jsonString = responseValue.substring(jsonStart, jsonEnd + 1);
	// Parse the JSON string into an object
	const json = JSON.parse(jsonString);
	// Use the response object as needed
	setTimeout(function (){
		var s = document.getElementById('saving_indicator');
		if (json.error == 0){
			s.innerHTML = 'all saved'
		}else{
			s.innerHTML = 'error :('
		}
	}, 500);
	});
// Get reference to the form and iframe elements
const form = document.getElementById('target');
const iframe = document.getElementById('transFrame');

// Define the interval duration in milliseconds (5 minutes = 5 * 60 * 1000 ms)
const intervalDuration = 5 * 60 * 1000;

// Set the target of the form to the iframe
form.target = iframe.name;

// Function to submit the form to the iframe
function submitFormToIframe() {
  form.submit();
}

// Submit the form initially
submitFormToIframe();

// Set up the interval to submit the form every 5 minutes
setInterval(submitFormToIframe, intervalDuration);
</script>

<div style='padding:10px;border:1px dashed grey;'>
{{context.point.p_content|ToMarkdown:context.point.id|safe}}
</div>

{%endblock%}
